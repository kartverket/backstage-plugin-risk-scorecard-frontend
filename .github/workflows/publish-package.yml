name: Publish RiSc plugin to npmjs
permissions:
  contents: write # Needed to create releases and push tags
  issues: write # Needed to comment on released issues
  pull-requests: write # Needed to comment on released PRs
  id-token: write # Required for OIDC trusted publishing to npm

# Make sure that only one publish job runs on main at the same time to avoid version conflicts
concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for commit analysis
          persist-credentials: true # Needed to push tags

      - run: corepack enable

      - name: Use Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: '22.x'
          registry-url: 'https://registry.npmjs.org'
          scope: '@kartverket'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build plugin
        run: |
          yarn tsc
          yarn build
        working-directory: plugins/ros

      - name: Analyze Release (Dry Run)
        if: github.event_name == 'pull_request'
        id: dry_run
        run: |
          chmod +x ./build-tools/*.sh
          ./build-tools/release.sh --dry-run >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WILL_RELEASE="${{ steps.dry_run.outputs.WILL_RELEASE }}"
          CURRENT_VERSION="${{ steps.dry_run.outputs.CURRENT_VERSION }}"
          NEXT_VERSION="${{ steps.dry_run.outputs.NEXT_VERSION }}"
          BUMP_TYPE="${{ steps.dry_run.outputs.BUMP_TYPE }}"

          # Build comment body
          if [ "$WILL_RELEASE" = "true" ]; then
            COMMENT="## üöÄ Release Preview

          **Current version:** \`$CURRENT_VERSION\`
          **Next version:** \`$NEXT_VERSION\`
          **Bump type:** \`$BUMP_TYPE\`

          When merged to main, this will automatically publish version \`$NEXT_VERSION\` to npm."
          else
            COMMENT="## ‚ÑπÔ∏è Release Preview

          This PR will **not** trigger a release.

          No relevant changes detected. To trigger a release, commits must:
          - Follow [conventional commit](https://www.conventionalcommits.org/) format
          - Use types: \`feat:\`, \`fix:\`, \`perf:\`, or \`revert:\`
          - Modify files in \`plugins/ros/\`"
          fi

          # Create or update comment
          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT" --edit-last || \
            gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT"

      - name: Release
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # NPM_TOKEN is optional if OIDC trusted publishing is configured on npmjs.com
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: |
          chmod +x ./build-tools/*.sh
          ./build-tools/release.sh
